@using Microsoft.AspNetCore.Components.Authorization

<AuthorizeView>
    <Authorized>
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-light dropdown-toggle d-flex align-items-center gap-2" 
                    type="button" 
                    data-bs-toggle="dropdown" 
                    aria-expanded="false">
                @if (!string.IsNullOrEmpty(GetUserPicture(context)))
                {
                    <img src="@GetUserPicture(context)" alt="Profile" class="rounded-circle" width="24" height="24" />
                }
                else
                {
                    <i class="bi bi-person-circle"></i>
                }
                <span class="d-none d-md-inline">@GetUserName(context)</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><span class="dropdown-item-text text-muted small">@GetUserEmail(context)</span></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/settings"><i class="bi bi-gear me-2"></i>Settings</a></li>
                <li><a class="dropdown-item text-danger" href="/logout"><i class="bi bi-box-arrow-right me-2"></i>Sign out</a></li>
            </ul>
        </div>
    </Authorized>
    <NotAuthorized>
        <a href="/login?returnUrl=@CurrentUrl" class="btn btn-sm btn-primary d-flex align-items-center gap-2">
            <i class="bi bi-google"></i>
            <span>Sign in with Google</span>
        </a>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public string? CurrentUrl { get; set; }

    private string GetUserName(AuthenticationState context)
    {
        return context.User.Identity?.Name ?? 
               context.User.Claims.FirstOrDefault(c => c.Type == "name")?.Value ?? 
               "User";
    }

    private string GetUserEmail(AuthenticationState context)
    {
        return context.User.Claims.FirstOrDefault(c => c.Type == System.Security.Claims.ClaimTypes.Email)?.Value ?? "";
    }

    private string GetUserPicture(AuthenticationState context)
    {
        return context.User.Claims.FirstOrDefault(c => c.Type == "picture")?.Value ?? "";
    }
}
